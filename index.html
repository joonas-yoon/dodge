<!DOCTYPE html>
<html>
<head>
    <title>Dodge</title>
    <link rel="stylesheet" href="site.css" />
</head>
<body>
    <div class="container">
        <canvas id="game" width="300" height="300"></canvas>
    </div>
</body>
<script>
    var canvas = document.getElementById("game");
    var ctx = canvas.getContext("2d");

    var rubbles = [];
    var player = {
        x: canvas.width / 2,
        y: canvas.height / 2,
        deg: 0,
        scale: 1.5
    };
    var keypressed = {};
    
    // x: [0, 1], y: [0, 1]; the 1 means width/height
    function createRubble(x, y) {
        return {
            x: x * canvas.width,
            y: y * canvas.height,
            color: '#ffff66'
        };
    }

    function spawnRubblesFromOutside(num) {
        for(var i=0; i<num; ++i) {
            var x, y, rand = Math.random() < 0.5 ? 0 : 1;
            if (Math.random() < 0.5) {
                x = rand, y = Math.random();
            } else {
                x = Math.random(), y = rand;
            }
            rubbles.push(createRubble(x, y));
        }
    }
    
    function rotatedXY(x, y, deg) {
        return {
            x: x * Math.cos(deg) - y * Math.sin(deg),
            y: x * Math.sin(deg) + y * Math.cos(deg)
        };
    }

    function moveRubble(r) {
        var dx = player.x - r.x;
        var dy = player.y - r.y;
        r.x += Math.max(0.25, Math.abs(dx) / 200) * (dx < 0 ? -1 : 1);
        r.y += Math.max(0.25, Math.abs(dy) / 200) * (dy < 0 ? -1 : 1);
    }

    function drawPlayer() {
        ctx.save();
        ctx.beginPath();
        var p1 = rotatedXY(0, -4 * player.scale, player.deg);
        var p2 = rotatedXY(2 * player.scale, 2 * player.scale, player.deg);
        var p3 = rotatedXY(-2 * player.scale, 2 * player.scale, player.deg);
        ctx.moveTo(player.x + p1.x, player.y + p1.y);
        ctx.lineTo(player.x + p2.x, player.y + p2.y);
        ctx.lineTo(player.x + p3.x, player.y + p3.y);
        ctx.fillStyle = 'white';
        ctx.fill();
        ctx.closePath();
        ctx.restore();
    }

    for(var i=0; i<10; ++i){
        rubbles.push(createRubble(Math.random(), Math.random()));
    }

    document.addEventListener('keydown', function(evt){
        keypressed[evt.keyCode] = true;
    });
    
    document.addEventListener('keyup', function(evt){
        delete keypressed[evt.keyCode];
    });

    // draw updates
    setInterval(function(){
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        rubbles.forEach(function(v, i){
            ctx.beginPath();
            ctx.arc(v.x, v.y, 1.5, 0, 2 * Math.PI);
            ctx.fillStyle = v.color;
            ctx.fill();
            ctx.closePath();

            /* debug */
            ctx.beginPath();
            ctx.moveTo(v.x, v.y);
            ctx.lineTo(player.x, player.y);
            ctx.strokeStyle = 'rgba(255, 255, 255, .1)';
            ctx.stroke();
            ctx.closePath();
            /* end debug */
        });
        drawPlayer();
    }, 10);
    
    // rubble state updates
    setInterval(function(){
        rubbles.forEach(moveRubble);
    }, 100);

    // player state updates
    setInterval(function(){
        // left = 37, up = 38, right = 39, down = 40
        if (keypressed[37]) player.deg -= 0.1; // 10 deg
        if (keypressed[39]) player.deg += 0.1;
        if (keypressed[38] || keypressed[40]) {
            var d = rotatedXY(0, keypressed[38] ? -2 : 2, player.deg);
            player.x += d.x;
            player.y += d.y;
        }
    }, 20);

    // spawn 10 rubbles for every 10 seconds
    setInterval(function(){
        spawnRubblesFromOutside(10);
    }, 10 * 1000);

</script>
</html>
